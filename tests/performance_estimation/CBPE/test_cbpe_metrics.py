import pandas as pd
import pytest

from nannyml.chunk import DefaultChunker
from nannyml.datasets import (
    load_synthetic_binary_classification_dataset,
    load_synthetic_multiclass_classification_dataset,
)
from nannyml.performance_estimation.confidence_based import CBPE
from nannyml.performance_estimation.confidence_based.metrics import (
    BinaryClassificationAccuracy,
    BinaryClassificationAUROC,
    BinaryClassificationConfusionMatrix,
    BinaryClassificationF1,
    BinaryClassificationPrecision,
    BinaryClassificationRecall,
    BinaryClassificationSpecificity,
)
from nannyml.thresholds import ConstantThreshold


@pytest.mark.parametrize(
    'calculator_opts, expected',
    [
        (
            {
                'chunk_size': 20000,
                'normalize_confusion_matrix': None,
                'business_value_matrix': [[2, -5], [-10, 10]],
                'normalize_business_value': None,
            },
            pd.DataFrame(
                {
                    'key': ['[0:19999]', '[20000:49999]'],
                    'estimated_roc_auc': [0.9711057564966745, 0.9636286015592977],
                    'estimated_f1': [0.9479079222515973, 0.9278089207836576],
                    'estimated_precision': [0.9436121782324026, 0.9197836255005452],
                    'estimated_recall': [0.9522429574319092, 0.9359754933378336],
                    'estimated_specificity': [0.9434949869571513, 0.9123732942949082],
                    'estimated_accuracy': [0.9478536003143163, 0.9245926106862006],
                    'estimated_true_positive': [9488.96406430504, 14537.180201036117],
                    'estimated_true_negative': [9468.107941981285, 13200.5981195499],
                    'estimated_false_positive': [567.0359356949585, 1267.8197989638852],
                    'estimated_false_negative': [475.8920580187156, 994.4018804500995],
                    'estimated_business_value': [106231.75626835103, 155489.88045014057],
                }
            ),
        ),
        (
            {
                'chunk_size': 20000,
                'normalize_confusion_matrix': None,
                'business_value_matrix': [[2, -5], [-10, 10]],
                'normalize_business_value': 'per_prediction',
            },
            pd.DataFrame(
                {
                    'key': ['[0:19999]', '[20000:49999]'],
                    'estimated_roc_auc': [0.9711057564966745, 0.9636286015592977],
                    'estimated_f1': [0.9479079222515973, 0.9278089207836576],
                    'estimated_precision': [0.9436121782324026, 0.9197836255005452],
                    'estimated_recall': [0.9522429574319092, 0.9359754933378336],
                    'estimated_specificity': [0.9434949869571513, 0.9123732942949082],
                    'estimated_accuracy': [0.9478536003143163, 0.9245926106862006],
                    'estimated_true_positive': [9488.96406430504, 14537.180201036117],
                    'estimated_true_negative': [9468.107941981285, 13200.5981195499],
                    'estimated_false_positive': [567.0359356949585, 1267.8197989638852],
                    'estimated_false_negative': [475.8920580187156, 994.4018804500995],
                    'estimated_business_value': [5.311587813417551, 5.182996015004686],
                }
            ),
        ),
        (
            {'chunk_size': 20000, 'normalize_confusion_matrix': 'all', 'business_value_matrix': [[-1, 4], [8, -8]]},
            pd.DataFrame(
                {
                    'key': ['[0:19999]', '[20000:49999]'],
                    'estimated_roc_auc': [0.9711057564966745, 0.9636286015592977],
                    'estimated_f1': [0.9479079222515973, 0.9278089207836576],
                    'estimated_precision': [0.9436121782324026, 0.9197836255005452],
                    'estimated_recall': [0.9522429574319092, 0.9359754933378336],
                    'estimated_specificity': [0.9434949869571513, 0.9123732942949082],
                    'estimated_accuracy': [0.9478536003143163, 0.9245926106862006],
                    'estimated_true_positive': [0.47444820321525205, 0.4845726733678706],
                    'estimated_true_negative': [0.47340539709906426, 0.44001993731833],
                    'estimated_false_positive': [0.02835179678474793, 0.04226065996546284],
                    'estimated_false_negative': [0.02379460290093578, 0.03314672934833665],
                    'estimated_business_value': [-79304.54024949206, -116471.5454883825],
                }
            ),
        ),
        (
            {'chunk_size': 20000, 'normalize_confusion_matrix': 'true', 'business_value_matrix': [[-1, 4], [8, -8]]},
            pd.DataFrame(
                {
                    'key': ['[0:19999]', '[20000:49999]'],
                    'estimated_roc_auc': [0.9711057564966745, 0.9636286015592977],
                    'estimated_f1': [0.9479079222515973, 0.9278089207836576],
                    'estimated_precision': [0.9436121782324026, 0.9197836255005452],
                    'estimated_recall': [0.9522429574319092, 0.9359754933378336],
                    'estimated_specificity': [0.9434949869571513, 0.9123732942949082],
                    'estimated_accuracy': [0.9478536003143163, 0.9245926106862006],
                    'estimated_true_positive': [0.9522429574319092, 0.9359754933378336],
                    'estimated_true_negative': [0.9434949869571514, 0.9123732942949082],
                    'estimated_false_positive': [0.05650501304284861, 0.08762670570509186],
                    'estimated_false_negative': [0.04775704256809077, 0.06402450666216646],
                    'estimated_business_value': [-79304.54024949206, -116471.5454883825],
                }
            ),
        ),
        (
            {'chunk_size': 20000, 'normalize_confusion_matrix': 'pred', 'business_value_matrix': [[-1, 4], [8, -8]]},
            pd.DataFrame(
                {
                    'key': ['[0:19999]', '[20000:49999]'],
                    'estimated_roc_auc': [0.9711057564966745, 0.9636286015592977],
                    'estimated_f1': [0.9479079222515973, 0.9278089207836576],
                    'estimated_precision': [0.9436121782324026, 0.9197836255005452],
                    'estimated_recall': [0.9522429574319092, 0.9359754933378336],
                    'estimated_specificity': [0.9434949869571513, 0.9123732942949082],
                    'estimated_accuracy': [0.9478536003143163, 0.9245926106862006],
                    'estimated_true_positive': [0.9436121782324026, 0.9197836255005452],
                    'estimated_true_negative': [0.952142793843653, 0.9299470320218318],
                    'estimated_false_positive': [0.05638782176759731, 0.08021637449945493],
                    'estimated_false_negative': [0.0478572061563471, 0.07005296797816835],
                    'estimated_business_value': [-79304.54024949206, -116471.5454883825],
                }
            ),
        ),
        (
            {
                'chunk_size': 20000,
                'normalize_confusion_matrix': None,
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': ['[0:19999]', '[20000:49999]'],
                    'estimated_roc_auc': [0.9711057564966745, 0.9636286015592977],
                    'estimated_f1': [0.9479079222515973, 0.9278089207836576],
                    'estimated_precision': [0.9436121782324026, 0.9197836255005452],
                    'estimated_recall': [0.9522429574319092, 0.9359754933378336],
                    'estimated_specificity': [0.9434949869571513, 0.9123732942949082],
                    'estimated_accuracy': [0.9478536003143163, 0.9245926106862006],
                    'estimated_true_positive': [9488.96406430504, 14537.180201036117],
                    'estimated_true_negative': [9468.107941981285, 13200.5981195499],
                    'estimated_false_positive': [567.0359356949585, 1267.8197989638852],
                    'estimated_false_negative': [475.8920580187156, 994.4018804500995],
                    'estimated_business_value': [-79304.54024949206, -116471.5454883825],
                }
            ),
        ),
        (
            {
                'chunk_size': 20000,
                'normalize_confusion_matrix': 'all',
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': ['[0:19999]', '[20000:49999]'],
                    'estimated_roc_auc': [0.9711057564966745, 0.9636286015592977],
                    'estimated_f1': [0.9479079222515973, 0.9278089207836576],
                    'estimated_precision': [0.9436121782324026, 0.9197836255005452],
                    'estimated_recall': [0.9522429574319092, 0.9359754933378336],
                    'estimated_specificity': [0.9434949869571513, 0.9123732942949082],
                    'estimated_accuracy': [0.9478536003143163, 0.9245926106862006],
                    'estimated_true_positive': [0.47444820321525205, 0.4845726733678706],
                    'estimated_true_negative': [0.47340539709906426, 0.44001993731833],
                    'estimated_false_positive': [0.02835179678474793, 0.04226065996546284],
                    'estimated_false_negative': [0.02379460290093578, 0.03314672934833665],
                    'estimated_business_value': [-79304.54024949206, -116471.5454883825],
                }
            ),
        ),
        (
            {
                'chunk_size': 20000,
                'normalize_confusion_matrix': 'all',
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[2, -5], [-10, 10]],
                'normalize_business_value': 'per_prediction',
            },
            pd.DataFrame(
                {
                    'key': ['[0:19999]', '[20000:49999]'],
                    'estimated_roc_auc': [0.9711057564966745, 0.9636286015592977],
                    'estimated_f1': [0.9479079222515973, 0.9278089207836576],
                    'estimated_precision': [0.9436121782324026, 0.9197836255005452],
                    'estimated_recall': [0.9522429574319092, 0.9359754933378336],
                    'estimated_specificity': [0.9434949869571513, 0.9123732942949082],
                    'estimated_accuracy': [0.9478536003143163, 0.9245926106862006],
                    'estimated_true_positive': [0.47444820321525205, 0.4845726733678706],
                    'estimated_true_negative': [0.47340539709906426, 0.44001993731833],
                    'estimated_false_positive': [0.02835179678474793, 0.04226065996546284],
                    'estimated_false_negative': [0.02379460290093578, 0.03314672934833665],
                    'estimated_business_value': [5.311587813417551, 5.182996015004686],
                }
            ),
        ),
        (
            {
                'chunk_size': 20000,
                'normalize_confusion_matrix': 'true',
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': ['[0:19999]', '[20000:49999]'],
                    'estimated_roc_auc': [0.9711057564966745, 0.9636286015592977],
                    'estimated_f1': [0.9479079222515973, 0.9278089207836576],
                    'estimated_precision': [0.9436121782324026, 0.9197836255005452],
                    'estimated_recall': [0.9522429574319092, 0.9359754933378336],
                    'estimated_specificity': [0.9434949869571513, 0.9123732942949082],
                    'estimated_accuracy': [0.9478536003143163, 0.9245926106862006],
                    'estimated_true_positive': [0.9522429574319092, 0.9359754933378336],
                    'estimated_true_negative': [0.9434949869571514, 0.9123732942949082],
                    'estimated_false_positive': [0.05650501304284861, 0.08762670570509186],
                    'estimated_false_negative': [0.04775704256809077, 0.06402450666216646],
                    'estimated_business_value': [-79304.54024949206, -116471.5454883825],
                }
            ),
        ),
        (
            {
                'chunk_size': 20000,
                'normalize_confusion_matrix': 'pred',
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': ['[0:19999]', '[20000:49999]'],
                    'estimated_roc_auc': [0.9711057564966745, 0.9636286015592977],
                    'estimated_f1': [0.9479079222515973, 0.9278089207836576],
                    'estimated_precision': [0.9436121782324026, 0.9197836255005452],
                    'estimated_recall': [0.9522429574319092, 0.9359754933378336],
                    'estimated_specificity': [0.9434949869571513, 0.9123732942949082],
                    'estimated_accuracy': [0.9478536003143163, 0.9245926106862006],
                    'estimated_true_positive': [0.9436121782324026, 0.9197836255005452],
                    'estimated_true_negative': [0.952142793843653, 0.9299470320218318],
                    'estimated_false_positive': [0.05638782176759731, 0.08021637449945493],
                    'estimated_false_negative': [0.0478572061563471, 0.07005296797816835],
                    'estimated_business_value': [-79304.54024949206, -116471.5454883825],
                }
            ),
        ),
        (
            {'chunk_number': 4, 'normalize_confusion_matrix': None, 'business_value_matrix': [[-1, 4], [8, -8]]},
            pd.DataFrame(
                {
                    'key': ['[0:12499]', '[12500:24999]', '[25000:37499]', '[37500:49999]'],
                    'estimated_roc_auc': [
                        0.9710577647083807,
                        0.9711638319733471,
                        0.9614012753095441,
                        0.9617878072895653,
                    ],
                    'estimated_f1': [0.9478220802546018, 0.9483683062849226, 0.9235839411719146, 0.9239534478264141],
                    'estimated_precision': [
                        0.9432817252782693,
                        0.9446550044048795,
                        0.9145613073300847,
                        0.915231419744167,
                    ],
                    'estimated_recall': [0.9524063553647716, 0.9521109162736728, 0.9327863750020324, 0.932843314818147],
                    'estimated_specificity': [
                        0.9426505776503413,
                        0.9446298328855539,
                        0.9050174893945843,
                        0.9065202406788675,
                    ],
                    'estimated_accuracy': [
                        0.9475319773956268,
                        0.9483565214666658,
                        0.9194997180834459,
                        0.920199809204049,
                    ],
                    'estimated_true_positive': [
                        5956.8240951322705,
                        5928.6548076450235,
                        6080.918132437733,
                        6059.74723012613,
                    ],
                    'estimated_true_negative': [
                        5887.325622313064,
                        5925.8017106883,
                        5412.82834360534,
                        5442.750384924482,
                    ],
                    'estimated_false_positive': [
                        358.1759048677297,
                        347.3451923549768,
                        568.0818675622668,
                        561.2527698738705,
                    ],
                    'estimated_false_negative': [
                        297.6743776869358,
                        298.19828931170053,
                        438.1716563946605,
                        436.2496150755182,
                    ],
                    'estimated_business_value': [
                        -49727.81974240482,
                        -49580.07308793498,
                        -48282.472681700856,
                        -48185.720225833895,
                    ],
                }
            ),
        ),
        (
            {'chunk_number': 4, 'normalize_confusion_matrix': 'all', 'business_value_matrix': [[-1, 4], [8, -8]]},
            pd.DataFrame(
                {
                    'key': ['[0:12499]', '[12500:24999]', '[25000:37499]', '[37500:49999]'],
                    'estimated_roc_auc': [
                        0.9710577647083807,
                        0.9711638319733471,
                        0.9614012753095441,
                        0.9617878072895653,
                    ],
                    'estimated_f1': [0.9478220802546018, 0.9483683062849226, 0.9235839411719146, 0.9239534478264141],
                    'estimated_precision': [
                        0.9432817252782693,
                        0.9446550044048795,
                        0.9145613073300847,
                        0.915231419744167,
                    ],
                    'estimated_recall': [0.9524063553647716, 0.9521109162736728, 0.9327863750020324, 0.932843314818147],
                    'estimated_specificity': [
                        0.9426505776503413,
                        0.9446298328855539,
                        0.9050174893945843,
                        0.9065202406788675,
                    ],
                    'estimated_accuracy': [
                        0.9475319773956268,
                        0.9483565214666658,
                        0.9194997180834459,
                        0.920199809204049,
                    ],
                    'estimated_true_positive': [
                        0.4765459276105816,
                        0.4742923846116019,
                        0.4864734505950187,
                        0.48477977841009035,
                    ],
                    'estimated_true_negative': [
                        0.4709860497850451,
                        0.474064136855064,
                        0.4330262674884272,
                        0.4354200307939586,
                    ],
                    'estimated_false_positive': [
                        0.028654072389418375,
                        0.027787615388398145,
                        0.04544654940498134,
                        0.044900221589909646,
                    ],
                    'estimated_false_negative': [
                        0.023813950214954867,
                        0.023855863144936044,
                        0.03505373251157284,
                        0.03489996920604146,
                    ],
                    'estimated_business_value': [
                        -49727.81974240482,
                        -49580.07308793498,
                        -48282.472681700856,
                        -48185.720225833895,
                    ],
                }
            ),
        ),
        (
            {'chunk_number': 4, 'normalize_confusion_matrix': 'true', 'business_value_matrix': [[-1, 4], [8, -8]]},
            pd.DataFrame(
                {
                    'key': ['[0:12499]', '[12500:24999]', '[25000:37499]', '[37500:49999]'],
                    'estimated_roc_auc': [
                        0.9710577647083807,
                        0.9711638319733471,
                        0.9614012753095441,
                        0.9617878072895653,
                    ],
                    'estimated_f1': [0.9478220802546018, 0.9483683062849226, 0.9235839411719146, 0.9239534478264141],
                    'estimated_precision': [
                        0.9432817252782693,
                        0.9446550044048795,
                        0.9145613073300847,
                        0.915231419744167,
                    ],
                    'estimated_recall': [0.9524063553647716, 0.9521109162736728, 0.9327863750020324, 0.932843314818147],
                    'estimated_specificity': [
                        0.9426505776503413,
                        0.9446298328855539,
                        0.9050174893945843,
                        0.9065202406788675,
                    ],
                    'estimated_accuracy': [
                        0.9475319773956268,
                        0.9483565214666658,
                        0.9194997180834459,
                        0.920199809204049,
                    ],
                    'estimated_true_positive': [
                        0.9524063553647716,
                        0.9521109162736727,
                        0.9327863750020323,
                        0.932843314818147,
                    ],
                    'estimated_true_negative': [
                        0.9426505776503413,
                        0.9446298328855538,
                        0.9050174893945843,
                        0.9065202406788674,
                    ],
                    'estimated_false_positive': [
                        0.057349422349658695,
                        0.055370167114446193,
                        0.09498251060541579,
                        0.09347975932113255,
                    ],
                    'estimated_false_negative': [
                        0.04759364463522837,
                        0.047889083726327226,
                        0.06721362499796762,
                        0.06715668518185315,
                    ],
                    'estimated_business_value': [
                        -49727.81974240482,
                        -49580.07308793498,
                        -48282.472681700856,
                        -48185.720225833895,
                    ],
                }
            ),
        ),
        (
            {'chunk_number': 4, 'normalize_confusion_matrix': 'pred', 'business_value_matrix': [[-1, 4], [8, -8]]},
            pd.DataFrame(
                {
                    'key': ['[0:12499]', '[12500:24999]', '[25000:37499]', '[37500:49999]'],
                    'estimated_roc_auc': [
                        0.9710577647083807,
                        0.9711638319733471,
                        0.9614012753095441,
                        0.9617878072895653,
                    ],
                    'estimated_f1': [0.9478220802546018, 0.9483683062849226, 0.9235839411719146, 0.9239534478264141],
                    'estimated_precision': [
                        0.9432817252782693,
                        0.9446550044048795,
                        0.9145613073300847,
                        0.915231419744167,
                    ],
                    'estimated_recall': [0.9524063553647716, 0.9521109162736728, 0.9327863750020324, 0.932843314818147],
                    'estimated_specificity': [
                        0.9426505776503413,
                        0.9446298328855539,
                        0.9050174893945843,
                        0.9065202406788675,
                    ],
                    'estimated_accuracy': [
                        0.9475319773956268,
                        0.9483565214666658,
                        0.9194997180834459,
                        0.920199809204049,
                    ],
                    'estimated_true_positive': [
                        0.9432817252782693,
                        0.9446550044048793,
                        0.9145613073300847,
                        0.9152314197441669,
                    ],
                    'estimated_true_negative': [
                        0.9518715638339635,
                        0.9520889637995341,
                        0.925111663579788,
                        0.925795268740344,
                    ],
                    'estimated_false_positive': [
                        0.05671827472173075,
                        0.05534499559512058,
                        0.08543869266991529,
                        0.08476858025583303,
                    ],
                    'estimated_false_negative': [
                        0.048128436166036515,
                        0.04791103620046603,
                        0.074888336420212,
                        0.0742047312596561,
                    ],
                    'estimated_business_value': [
                        -49727.81974240482,
                        -49580.07308793498,
                        -48282.472681700856,
                        -48185.720225833895,
                    ],
                }
            ),
        ),
        (
            {
                'chunk_number': 4,
                'normalize_confusion_matrix': None,
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': ['[0:12499]', '[12500:24999]', '[25000:37499]', '[37500:49999]'],
                    'estimated_roc_auc': [
                        0.9710577647083807,
                        0.9711638319733471,
                        0.9614012753095441,
                        0.9617878072895653,
                    ],
                    'estimated_f1': [0.9478220802546018, 0.9483683062849226, 0.9235839411719146, 0.9239534478264141],
                    'estimated_precision': [
                        0.9432817252782693,
                        0.9446550044048795,
                        0.9145613073300847,
                        0.915231419744167,
                    ],
                    'estimated_recall': [0.9524063553647716, 0.9521109162736728, 0.9327863750020324, 0.932843314818147],
                    'estimated_specificity': [
                        0.9426505776503413,
                        0.9446298328855539,
                        0.9050174893945843,
                        0.9065202406788675,
                    ],
                    'estimated_accuracy': [
                        0.9475319773956268,
                        0.9483565214666658,
                        0.9194997180834459,
                        0.920199809204049,
                    ],
                    'estimated_true_positive': [
                        5956.8240951322705,
                        5928.6548076450235,
                        6080.918132437733,
                        6059.74723012613,
                    ],
                    'estimated_true_negative': [
                        5887.325622313064,
                        5925.8017106883,
                        5412.82834360534,
                        5442.750384924482,
                    ],
                    'estimated_false_positive': [
                        358.1759048677297,
                        347.3451923549768,
                        568.0818675622668,
                        561.2527698738705,
                    ],
                    'estimated_false_negative': [
                        297.6743776869358,
                        298.19828931170053,
                        438.1716563946605,
                        436.2496150755182,
                    ],
                    'estimated_business_value': [
                        -49727.81974240482,
                        -49580.07308793498,
                        -48282.472681700856,
                        -48185.720225833895,
                    ],
                }
            ),
        ),
        (
            {
                'chunk_number': 4,
                'normalize_confusion_matrix': 'all',
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': ['[0:12499]', '[12500:24999]', '[25000:37499]', '[37500:49999]'],
                    'estimated_roc_auc': [
                        0.9710577647083807,
                        0.9711638319733471,
                        0.9614012753095441,
                        0.9617878072895653,
                    ],
                    'estimated_f1': [0.9478220802546018, 0.9483683062849226, 0.9235839411719146, 0.9239534478264141],
                    'estimated_precision': [
                        0.9432817252782693,
                        0.9446550044048795,
                        0.9145613073300847,
                        0.915231419744167,
                    ],
                    'estimated_recall': [0.9524063553647716, 0.9521109162736728, 0.9327863750020324, 0.932843314818147],
                    'estimated_specificity': [
                        0.9426505776503413,
                        0.9446298328855539,
                        0.9050174893945843,
                        0.9065202406788675,
                    ],
                    'estimated_accuracy': [
                        0.9475319773956268,
                        0.9483565214666658,
                        0.9194997180834459,
                        0.920199809204049,
                    ],
                    'estimated_true_positive': [
                        0.4765459276105816,
                        0.4742923846116019,
                        0.4864734505950187,
                        0.48477977841009035,
                    ],
                    'estimated_true_negative': [
                        0.4709860497850451,
                        0.474064136855064,
                        0.4330262674884272,
                        0.4354200307939586,
                    ],
                    'estimated_false_positive': [
                        0.028654072389418375,
                        0.027787615388398145,
                        0.04544654940498134,
                        0.044900221589909646,
                    ],
                    'estimated_false_negative': [
                        0.023813950214954867,
                        0.023855863144936044,
                        0.03505373251157284,
                        0.03489996920604146,
                    ],
                    'estimated_business_value': [
                        -49727.81974240482,
                        -49580.07308793498,
                        -48282.472681700856,
                        -48185.720225833895,
                    ],
                }
            ),
        ),
        (
            {
                'chunk_number': 4,
                'normalize_confusion_matrix': 'true',
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': ['[0:12499]', '[12500:24999]', '[25000:37499]', '[37500:49999]'],
                    'estimated_roc_auc': [
                        0.9710577647083807,
                        0.9711638319733471,
                        0.9614012753095441,
                        0.9617878072895653,
                    ],
                    'estimated_f1': [0.9478220802546018, 0.9483683062849226, 0.9235839411719146, 0.9239534478264141],
                    'estimated_precision': [
                        0.9432817252782693,
                        0.9446550044048795,
                        0.9145613073300847,
                        0.915231419744167,
                    ],
                    'estimated_recall': [0.9524063553647716, 0.9521109162736728, 0.9327863750020324, 0.932843314818147],
                    'estimated_specificity': [
                        0.9426505776503413,
                        0.9446298328855539,
                        0.9050174893945843,
                        0.9065202406788675,
                    ],
                    'estimated_accuracy': [
                        0.9475319773956268,
                        0.9483565214666658,
                        0.9194997180834459,
                        0.920199809204049,
                    ],
                    'estimated_true_positive': [
                        0.9524063553647716,
                        0.9521109162736727,
                        0.9327863750020323,
                        0.932843314818147,
                    ],
                    'estimated_true_negative': [
                        0.9426505776503413,
                        0.9446298328855538,
                        0.9050174893945843,
                        0.9065202406788674,
                    ],
                    'estimated_false_positive': [
                        0.057349422349658695,
                        0.055370167114446193,
                        0.09498251060541579,
                        0.09347975932113255,
                    ],
                    'estimated_false_negative': [
                        0.04759364463522837,
                        0.047889083726327226,
                        0.06721362499796762,
                        0.06715668518185315,
                    ],
                    'estimated_business_value': [
                        -49727.81974240482,
                        -49580.07308793498,
                        -48282.472681700856,
                        -48185.720225833895,
                    ],
                }
            ),
        ),
        (
            {
                'chunk_number': 4,
                'normalize_confusion_matrix': 'pred',
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': ['[0:12499]', '[12500:24999]', '[25000:37499]', '[37500:49999]'],
                    'estimated_roc_auc': [
                        0.9710577647083807,
                        0.9711638319733471,
                        0.9614012753095441,
                        0.9617878072895653,
                    ],
                    'estimated_f1': [0.9478220802546018, 0.9483683062849226, 0.9235839411719146, 0.9239534478264141],
                    'estimated_precision': [
                        0.9432817252782693,
                        0.9446550044048795,
                        0.9145613073300847,
                        0.915231419744167,
                    ],
                    'estimated_recall': [0.9524063553647716, 0.9521109162736728, 0.9327863750020324, 0.932843314818147],
                    'estimated_specificity': [
                        0.9426505776503413,
                        0.9446298328855539,
                        0.9050174893945843,
                        0.9065202406788675,
                    ],
                    'estimated_accuracy': [
                        0.9475319773956268,
                        0.9483565214666658,
                        0.9194997180834459,
                        0.920199809204049,
                    ],
                    'estimated_true_positive': [
                        0.9432817252782693,
                        0.9446550044048793,
                        0.9145613073300847,
                        0.9152314197441669,
                    ],
                    'estimated_true_negative': [
                        0.9518715638339635,
                        0.9520889637995341,
                        0.925111663579788,
                        0.925795268740344,
                    ],
                    'estimated_false_positive': [
                        0.05671827472173075,
                        0.05534499559512058,
                        0.08543869266991529,
                        0.08476858025583303,
                    ],
                    'estimated_false_negative': [
                        0.048128436166036515,
                        0.04791103620046603,
                        0.074888336420212,
                        0.0742047312596561,
                    ],
                    'estimated_business_value': [
                        -49727.81974240482,
                        -49580.07308793498,
                        -48282.472681700856,
                        -48185.720225833895,
                    ],
                }
            ),
        ),
        (
            {
                'chunk_period': 'Y',
                'normalize_confusion_matrix': None,
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': ['2017', '2018', '2019', '2020', '2021'],
                    'estimated_roc_auc': [
                        0.970765243491131,
                        0.9711789504176722,
                        0.96539407871315,
                        0.9616920614348379,
                        0.9225012697206918,
                    ],
                    'estimated_f1': [
                        0.9486231864324036,
                        0.9477092734637503,
                        0.9315900332119164,
                        0.9240488520044474,
                        0.7926388251111386,
                    ],
                    'estimated_precision': [
                        0.9425338528308135,
                        0.9440235151260787,
                        0.9244858823267199,
                        0.9151737753536913,
                        0.7100248791165871,
                    ],
                    'estimated_recall': [
                        0.9547917131585199,
                        0.9514239252802291,
                        0.9388042123614001,
                        0.9330977499034733,
                        0.8970090514396291,
                    ],
                    'estimated_specificity': [
                        0.937163050852636,
                        0.9454556899788352,
                        0.918667486315966,
                        0.9060337870230502,
                        0.8302703490347314,
                    ],
                    'estimated_accuracy': [
                        0.9463140395517069,
                        0.9483894898124492,
                        0.9290320609580357,
                        0.9201265813431901,
                        0.8514010785547443,
                    ],
                    'estimated_true_positive': [
                        2454.358152771438,
                        7049.967610961557,
                        7243.346888029851,
                        7275.631514061845,
                        2.8400995164663483,
                    ],
                    'estimated_true_negative': [
                        2231.7889710886143,
                        7246.055558471303,
                        6682.843705731104,
                        6502.343914971083,
                        5.673911269081095,
                    ],
                    'estimated_false_positive': [
                        149.64184722856197,
                        418.03238903844397,
                        591.6531119701493,
                        674.3684859381549,
                        1.1599004835336515,
                    ],
                    'estimated_false_negative': [
                        116.21102891138604,
                        359.944441528697,
                        472.15629426889626,
                        521.6560850289168,
                        0.32608873091890567,
                    ],
                    'estimated_business_value': [
                        -20338.398573054783,
                        -59094.1113577804,
                        -58485.756007938144,
                        -57836.67340348189,
                        -21.14639561932603,
                    ],
                }
            ),
        ),
        (
            {
                'chunk_period': 'Y',
                'normalize_confusion_matrix': 'all',
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': ['2017', '2018', '2019', '2020', '2021'],
                    'estimated_roc_auc': [
                        0.970765243491131,
                        0.9711789504176722,
                        0.96539407871315,
                        0.9616920614348379,
                        0.9225012697206918,
                    ],
                    'estimated_f1': [
                        0.9486231864324036,
                        0.9477092734637503,
                        0.9315900332119164,
                        0.9240488520044474,
                        0.7926388251111386,
                    ],
                    'estimated_precision': [
                        0.9425338528308135,
                        0.9440235151260787,
                        0.9244858823267199,
                        0.9151737753536913,
                        0.7100248791165871,
                    ],
                    'estimated_recall': [
                        0.9547917131585199,
                        0.9514239252802291,
                        0.9388042123614001,
                        0.9330977499034733,
                        0.8970090514396291,
                    ],
                    'estimated_specificity': [
                        0.937163050852636,
                        0.9454556899788352,
                        0.918667486315966,
                        0.9060337870230502,
                        0.8302703490347314,
                    ],
                    'estimated_accuracy': [
                        0.9463140395517069,
                        0.9483894898124492,
                        0.9290320609580357,
                        0.9201265813431901,
                        0.8514010785547443,
                    ],
                    'estimated_true_positive': [
                        0.49562967543849723,
                        0.4676905672655935,
                        0.48321193382453975,
                        0.48588430039146824,
                        0.28400995164663484,
                    ],
                    'estimated_true_negative': [
                        0.45068436411320967,
                        0.4806989225468557,
                        0.44582012713349595,
                        0.43424228095172185,
                        0.5673911269081094,
                    ],
                    'estimated_false_positive': [
                        0.030218466726284726,
                        0.027732014663556053,
                        0.03946985403403264,
                        0.04503596139562942,
                        0.11599004835336515,
                    ],
                    'estimated_false_negative': [
                        0.02346749372200849,
                        0.023878495523994757,
                        0.031498085007931706,
                        0.034837457261180496,
                        0.03260887309189057,
                    ],
                    'estimated_business_value': [
                        -20338.398573054783,
                        -59094.1113577804,
                        -58485.756007938144,
                        -57836.67340348189,
                        -21.14639561932603,
                    ],
                }
            ),
        ),
        (
            {
                'chunk_period': 'Y',
                'normalize_confusion_matrix': 'true',
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': ['2017', '2018', '2019', '2020', '2021'],
                    'estimated_roc_auc': [
                        0.970765243491131,
                        0.9711789504176722,
                        0.96539407871315,
                        0.9616920614348379,
                        0.9225012697206918,
                    ],
                    'estimated_f1': [
                        0.9486231864324036,
                        0.9477092734637503,
                        0.9315900332119164,
                        0.9240488520044474,
                        0.7926388251111386,
                    ],
                    'estimated_precision': [
                        0.9425338528308135,
                        0.9440235151260787,
                        0.9244858823267199,
                        0.9151737753536913,
                        0.7100248791165871,
                    ],
                    'estimated_recall': [
                        0.9547917131585199,
                        0.9514239252802291,
                        0.9388042123614001,
                        0.9330977499034733,
                        0.8970090514396291,
                    ],
                    'estimated_specificity': [
                        0.937163050852636,
                        0.9454556899788352,
                        0.918667486315966,
                        0.9060337870230502,
                        0.8302703490347314,
                    ],
                    'estimated_accuracy': [
                        0.9463140395517069,
                        0.9483894898124492,
                        0.9290320609580357,
                        0.9201265813431901,
                        0.8514010785547443,
                    ],
                    'estimated_true_positive': [
                        0.9547917131585199,
                        0.9514239252802291,
                        0.9388042123614001,
                        0.9330977499034733,
                        0.897009051439629,
                    ],
                    'estimated_true_negative': [
                        0.9371630508526361,
                        0.9454556899788352,
                        0.918667486315966,
                        0.9060337870230502,
                        0.8302703490347314,
                    ],
                    'estimated_false_positive': [
                        0.06283694914736405,
                        0.05454431002116476,
                        0.08133251368403405,
                        0.0939662129769499,
                        0.16972965096526862,
                    ],
                    'estimated_false_negative': [
                        0.04520828684148016,
                        0.04857607471977082,
                        0.06119578763859995,
                        0.06690225009652676,
                        0.10299094856037092,
                    ],
                    'estimated_business_value': [
                        -20338.398573054783,
                        -59094.1113577804,
                        -58485.756007938144,
                        -57836.67340348189,
                        -21.14639561932603,
                    ],
                }
            ),
        ),
        (
            {
                'chunk_period': 'Y',
                'normalize_confusion_matrix': 'pred',
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': ['2017', '2018', '2019', '2020', '2021'],
                    'estimated_roc_auc': [
                        0.970765243491131,
                        0.9711789504176722,
                        0.96539407871315,
                        0.9616920614348379,
                        0.9225012697206918,
                    ],
                    'estimated_f1': [
                        0.9486231864324036,
                        0.9477092734637503,
                        0.9315900332119164,
                        0.9240488520044474,
                        0.7926388251111386,
                    ],
                    'estimated_precision': [
                        0.9425338528308135,
                        0.9440235151260787,
                        0.9244858823267199,
                        0.9151737753536913,
                        0.7100248791165871,
                    ],
                    'estimated_recall': [
                        0.9547917131585199,
                        0.9514239252802291,
                        0.9388042123614001,
                        0.9330977499034733,
                        0.8970090514396291,
                    ],
                    'estimated_specificity': [
                        0.937163050852636,
                        0.9454556899788352,
                        0.918667486315966,
                        0.9060337870230502,
                        0.8302703490347314,
                    ],
                    'estimated_accuracy': [
                        0.9463140395517069,
                        0.9483894898124492,
                        0.9290320609580357,
                        0.9201265813431901,
                        0.8514010785547443,
                    ],
                    'estimated_true_positive': [
                        0.9425338528308134,
                        0.9440235151260786,
                        0.9244858823267198,
                        0.9151737753536914,
                        0.7100248791165871,
                    ],
                    'estimated_true_negative': [
                        0.9505063761024761,
                        0.9526762501277023,
                        0.9340103012901612,
                        0.9257323341359742,
                        0.9456518781801825,
                    ],
                    'estimated_false_positive': [
                        0.05746614716918662,
                        0.05597648487392125,
                        0.07551411767328006,
                        0.0848262246463088,
                        0.2899751208834129,
                    ],
                    'estimated_false_negative': [
                        0.04949362389752386,
                        0.04732374987229779,
                        0.06598969870983874,
                        0.07426766586402574,
                        0.054348121819817616,
                    ],
                    'estimated_business_value': [
                        -20338.398573054783,
                        -59094.1113577804,
                        -58485.756007938144,
                        -57836.67340348189,
                        -21.14639561932603,
                    ],
                }
            ),
        ),
        (
            {'normalize_confusion_matrix': None, 'business_value_matrix': [[-1, 4], [8, -8]]},
            pd.DataFrame(
                {
                    'key': [
                        '[0:4999]',
                        '[5000:9999]',
                        '[10000:14999]',
                        '[15000:19999]',
                        '[20000:24999]',
                        '[25000:29999]',
                        '[30000:34999]',
                        '[35000:39999]',
                        '[40000:44999]',
                        '[45000:49999]',
                    ],
                    'estimated_roc_auc': [
                        0.9707549113643061,
                        0.9710224276197865,
                        0.9714183710230127,
                        0.9711031289261209,
                        0.9711345926265325,
                        0.9611051833769545,
                        0.9618393909078314,
                        0.9610884839447085,
                        0.9625480927168266,
                        0.9613306854392768,
                    ],
                    'estimated_f1': [
                        0.948555321454138,
                        0.9465779465209089,
                        0.9488069354531159,
                        0.9476546805658866,
                        0.9488338110572719,
                        0.9232325655782327,
                        0.923595783273164,
                        0.9229020961475524,
                        0.9241722368115827,
                        0.9249152193013231,
                    ],
                    'estimated_precision': [
                        0.9425440716307568,
                        0.9431073537123396,
                        0.9442277523749669,
                        0.9446336452028188,
                        0.9453707449594683,
                        0.9148732952385749,
                        0.9143489884377147,
                        0.9133821290777778,
                        0.9173539177641505,
                        0.9145726617897999,
                    ],
                    'estimated_recall': [
                        0.9546437391537488,
                        0.95007417692678,
                        0.9534307499357034,
                        0.9506951010870748,
                        0.9523223421280594,
                        0.9317460031975845,
                        0.9330315141543621,
                        0.9326226021419973,
                        0.9310926704269641,
                        0.9354943725540698,
                    ],
                    'estimated_specificity': [
                        0.9372742491954283,
                        0.9446319110387503,
                        0.9458015988378999,
                        0.9459382667254527,
                        0.9442380077839293,
                        0.9054074470674046,
                        0.9054733303403276,
                        0.905142438988179,
                        0.9120143191041326,
                        0.9005790635739856,
                    ],
                    'estimated_accuracy': [
                        0.9462845122805443,
                        0.947306078326665,
                        0.949543087716159,
                        0.9482807229338969,
                        0.9483068458984663,
                        0.9191503008524827,
                        0.9197921095331023,
                        0.9193633916092473,
                        0.9217811573797979,
                        0.9191618588441066,
                    ],
                    'estimated_true_positive': [
                        2476.063276173998,
                        2334.1907004380405,
                        2337.9079148804176,
                        2340.802172812585,
                        2396.5148384722524,
                        2430.8183454488935,
                        2423.939168348382,
                        2413.155585023489,
                        2383.285478351263,
                        2489.4667853918354,
                    ],
                    'estimated_true_negative': [
                        2255.359285228724,
                        2402.339691195284,
                        2409.8075237003773,
                        2400.6014418568993,
                        2345.0193910200787,
                        2164.93315881352,
                        2175.0213793171297,
                        2183.6613730227473,
                        2225.6203085477264,
                        2106.3425088286976,
                    ],
                    'estimated_false_positive': [
                        150.93672382600215,
                        140.80929956195956,
                        138.09208511958207,
                        137.19782718741482,
                        138.48516152774786,
                        226.18165455110628,
                        227.06083165161834,
                        228.8444149765112,
                        214.71452164873693,
                        232.53321460816457,
                    ],
                    'estimated_false_negative': [
                        117.64071477127642,
                        122.66030880471597,
                        114.19247629962268,
                        121.39855814310047,
                        119.9806089799208,
                        178.06684118647985,
                        173.9786206828703,
                        174.338626977253,
                        176.37969145227322,
                        171.65749117130238,
                    ],
                    'estimated_business_value': [
                        -20518.99288114649,
                        -19531.34562601404,
                        -19647.162691868405,
                        -19607.039050463114,
                        -20003.352580847743,
                        -19282.218574708404,
                        -19266.462434034747,
                        -19178.81937748659,
                        -19022.008517144695,
                        -19718.684004160303,
                    ],
                }
            ),
        ),
        (
            {'normalize_confusion_matrix': 'all', 'business_value_matrix': [[-1, 4], [8, -8]]},
            pd.DataFrame(
                {
                    'key': [
                        '[0:4999]',
                        '[5000:9999]',
                        '[10000:14999]',
                        '[15000:19999]',
                        '[20000:24999]',
                        '[25000:29999]',
                        '[30000:34999]',
                        '[35000:39999]',
                        '[40000:44999]',
                        '[45000:49999]',
                    ],
                    'estimated_roc_auc': [
                        0.9707549113643061,
                        0.9710224276197865,
                        0.9714183710230127,
                        0.9711031289261209,
                        0.9711345926265325,
                        0.9611051833769545,
                        0.9618393909078314,
                        0.9610884839447085,
                        0.9625480927168266,
                        0.9613306854392768,
                    ],
                    'estimated_f1': [
                        0.948555321454138,
                        0.9465779465209089,
                        0.9488069354531159,
                        0.9476546805658866,
                        0.9488338110572719,
                        0.9232325655782327,
                        0.923595783273164,
                        0.9229020961475524,
                        0.9241722368115827,
                        0.9249152193013231,
                    ],
                    'estimated_precision': [
                        0.9425440716307568,
                        0.9431073537123396,
                        0.9442277523749669,
                        0.9446336452028188,
                        0.9453707449594683,
                        0.9148732952385749,
                        0.9143489884377147,
                        0.9133821290777778,
                        0.9173539177641505,
                        0.9145726617897999,
                    ],
                    'estimated_recall': [
                        0.9546437391537488,
                        0.95007417692678,
                        0.9534307499357034,
                        0.9506951010870748,
                        0.9523223421280594,
                        0.9317460031975845,
                        0.9330315141543621,
                        0.9326226021419973,
                        0.9310926704269641,
                        0.9354943725540698,
                    ],
                    'estimated_specificity': [
                        0.9372742491954283,
                        0.9446319110387503,
                        0.9458015988378999,
                        0.9459382667254527,
                        0.9442380077839293,
                        0.9054074470674046,
                        0.9054733303403276,
                        0.905142438988179,
                        0.9120143191041326,
                        0.9005790635739856,
                    ],
                    'estimated_accuracy': [
                        0.9462845122805443,
                        0.947306078326665,
                        0.949543087716159,
                        0.9482807229338969,
                        0.9483068458984663,
                        0.9191503008524827,
                        0.9197921095331023,
                        0.9193633916092473,
                        0.9217811573797979,
                        0.9191618588441066,
                    ],
                    'estimated_true_positive': [
                        0.4952126552347996,
                        0.4668381400876081,
                        0.46758158297608354,
                        0.468160434562517,
                        0.47930296769445047,
                        0.4861636690897787,
                        0.48478783366967637,
                        0.4826311170046978,
                        0.4766570956702526,
                        0.49789335707836707,
                    ],
                    'estimated_true_negative': [
                        0.45107185704574476,
                        0.4804679382390568,
                        0.48196150474007543,
                        0.4801202883713799,
                        0.46900387820401573,
                        0.432986631762704,
                        0.43500427586342594,
                        0.43673227460454944,
                        0.44512406170954527,
                        0.42126850176573954,
                    ],
                    'estimated_false_positive': [
                        0.03018734476520043,
                        0.028161859912391913,
                        0.027618417023916413,
                        0.027439565437482962,
                        0.02769703230554957,
                        0.04523633091022126,
                        0.04541216633032367,
                        0.04576888299530224,
                        0.042942904329747386,
                        0.04650664292163292,
                    ],
                    'estimated_false_negative': [
                        0.023528142954255284,
                        0.024532061760943195,
                        0.022838495259924537,
                        0.024279711628620096,
                        0.02399612179598416,
                        0.03561336823729597,
                        0.03479572413657406,
                        0.0348677253954506,
                        0.035275938290454646,
                        0.034331498234260474,
                    ],
                    'estimated_business_value': [
                        -20518.99288114649,
                        -19531.34562601404,
                        -19647.162691868405,
                        -19607.039050463114,
                        -20003.352580847743,
                        -19282.218574708404,
                        -19266.462434034747,
                        -19178.81937748659,
                        -19022.008517144695,
                        -19718.684004160303,
                    ],
                }
            ),
        ),
        (
            {'normalize_confusion_matrix': 'true', 'business_value_matrix': [[-1, 4], [8, -8]]},
            pd.DataFrame(
                {
                    'key': [
                        '[0:4999]',
                        '[5000:9999]',
                        '[10000:14999]',
                        '[15000:19999]',
                        '[20000:24999]',
                        '[25000:29999]',
                        '[30000:34999]',
                        '[35000:39999]',
                        '[40000:44999]',
                        '[45000:49999]',
                    ],
                    'estimated_roc_auc': [
                        0.9707549113643061,
                        0.9710224276197865,
                        0.9714183710230127,
                        0.9711031289261209,
                        0.9711345926265325,
                        0.9611051833769545,
                        0.9618393909078314,
                        0.9610884839447085,
                        0.9625480927168266,
                        0.9613306854392768,
                    ],
                    'estimated_f1': [
                        0.948555321454138,
                        0.9465779465209089,
                        0.9488069354531159,
                        0.9476546805658866,
                        0.9488338110572719,
                        0.9232325655782327,
                        0.923595783273164,
                        0.9229020961475524,
                        0.9241722368115827,
                        0.9249152193013231,
                    ],
                    'estimated_precision': [
                        0.9425440716307568,
                        0.9431073537123396,
                        0.9442277523749669,
                        0.9446336452028188,
                        0.9453707449594683,
                        0.9148732952385749,
                        0.9143489884377147,
                        0.9133821290777778,
                        0.9173539177641505,
                        0.9145726617897999,
                    ],
                    'estimated_recall': [
                        0.9546437391537488,
                        0.95007417692678,
                        0.9534307499357034,
                        0.9506951010870748,
                        0.9523223421280594,
                        0.9317460031975845,
                        0.9330315141543621,
                        0.9326226021419973,
                        0.9310926704269641,
                        0.9354943725540698,
                    ],
                    'estimated_specificity': [
                        0.9372742491954283,
                        0.9446319110387503,
                        0.9458015988378999,
                        0.9459382667254527,
                        0.9442380077839293,
                        0.9054074470674046,
                        0.9054733303403276,
                        0.905142438988179,
                        0.9120143191041326,
                        0.9005790635739856,
                    ],
                    'estimated_accuracy': [
                        0.9462845122805443,
                        0.947306078326665,
                        0.949543087716159,
                        0.9482807229338969,
                        0.9483068458984663,
                        0.9191503008524827,
                        0.9197921095331023,
                        0.9193633916092473,
                        0.9217811573797979,
                        0.9191618588441066,
                    ],
                    'estimated_true_positive': [
                        0.9546437391537488,
                        0.9500741769267799,
                        0.9534307499357034,
                        0.9506951010870749,
                        0.9523223421280593,
                        0.9317460031975845,
                        0.9330315141543621,
                        0.9326226021419972,
                        0.9310926704269642,
                        0.9354943725540699,
                    ],
                    'estimated_true_negative': [
                        0.9372742491954283,
                        0.9446319110387503,
                        0.9458015988378999,
                        0.9459382667254528,
                        0.9442380077839293,
                        0.9054074470674046,
                        0.9054733303403276,
                        0.9051424389881788,
                        0.9120143191041324,
                        0.9005790635739858,
                    ],
                    'estimated_false_positive': [
                        0.0627257508045717,
                        0.05536808896124974,
                        0.054198401162100104,
                        0.0540617332745473,
                        0.05576199221607062,
                        0.09459255293259536,
                        0.0945266696596724,
                        0.09485756101182109,
                        0.08798568089586746,
                        0.09942093642601435,
                    ],
                    'estimated_false_negative': [
                        0.04535626084625111,
                        0.04992582307322005,
                        0.04656925006429655,
                        0.04930489891292515,
                        0.0476776578719406,
                        0.06825399680241545,
                        0.06696848584563789,
                        0.06737739785800262,
                        0.06890732957303593,
                        0.06450562744593023,
                    ],
                    'estimated_business_value': [
                        -20518.99288114649,
                        -19531.34562601404,
                        -19647.162691868405,
                        -19607.039050463114,
                        -20003.352580847743,
                        -19282.218574708404,
                        -19266.462434034747,
                        -19178.81937748659,
                        -19022.008517144695,
                        -19718.684004160303,
                    ],
                }
            ),
        ),
        (
            {'normalize_confusion_matrix': 'pred', 'business_value_matrix': [[-1, 4], [8, -8]]},
            pd.DataFrame(
                {
                    'key': [
                        '[0:4999]',
                        '[5000:9999]',
                        '[10000:14999]',
                        '[15000:19999]',
                        '[20000:24999]',
                        '[25000:29999]',
                        '[30000:34999]',
                        '[35000:39999]',
                        '[40000:44999]',
                        '[45000:49999]',
                    ],
                    'estimated_roc_auc': [
                        0.9707549113643061,
                        0.9710224276197865,
                        0.9714183710230127,
                        0.9711031289261209,
                        0.9711345926265325,
                        0.9611051833769545,
                        0.9618393909078314,
                        0.9610884839447085,
                        0.9625480927168266,
                        0.9613306854392768,
                    ],
                    'estimated_f1': [
                        0.948555321454138,
                        0.9465779465209089,
                        0.9488069354531159,
                        0.9476546805658866,
                        0.9488338110572719,
                        0.9232325655782327,
                        0.923595783273164,
                        0.9229020961475524,
                        0.9241722368115827,
                        0.9249152193013231,
                    ],
                    'estimated_precision': [
                        0.9425440716307568,
                        0.9431073537123396,
                        0.9442277523749669,
                        0.9446336452028188,
                        0.9453707449594683,
                        0.9148732952385749,
                        0.9143489884377147,
                        0.9133821290777778,
                        0.9173539177641505,
                        0.9145726617897999,
                    ],
                    'estimated_recall': [
                        0.9546437391537488,
                        0.95007417692678,
                        0.9534307499357034,
                        0.9506951010870748,
                        0.9523223421280594,
                        0.9317460031975845,
                        0.9330315141543621,
                        0.9326226021419973,
                        0.9310926704269641,
                        0.9354943725540698,
                    ],
                    'estimated_specificity': [
                        0.9372742491954283,
                        0.9446319110387503,
                        0.9458015988378999,
                        0.9459382667254527,
                        0.9442380077839293,
                        0.9054074470674046,
                        0.9054733303403276,
                        0.905142438988179,
                        0.9120143191041326,
                        0.9005790635739856,
                    ],
                    'estimated_accuracy': [
                        0.9462845122805443,
                        0.947306078326665,
                        0.949543087716159,
                        0.9482807229338969,
                        0.9483068458984663,
                        0.9191503008524827,
                        0.9197921095331023,
                        0.9193633916092473,
                        0.9217811573797979,
                        0.9191618588441066,
                    ],
                    'estimated_true_positive': [
                        0.9425440716307567,
                        0.9431073537123397,
                        0.9442277523749669,
                        0.9446336452028189,
                        0.9453707449594684,
                        0.914873295238575,
                        0.9143489884377148,
                        0.9133821290777778,
                        0.9173539177641507,
                        0.9145726617897999,
                    ],
                    'estimated_true_negative': [
                        0.9504253203660866,
                        0.9514216598793204,
                        0.9547573390255062,
                        0.9518641720289054,
                        0.9513263249574359,
                        0.9240004945853693,
                        0.9259350273806426,
                        0.9260650436907325,
                        0.9265696538500111,
                        0.9246455262636951,
                    ],
                    'estimated_false_positive': [
                        0.05745592836924329,
                        0.056892646287660435,
                        0.055772247625033154,
                        0.055366354797181126,
                        0.054629255040531705,
                        0.08512670476142503,
                        0.0856510115622853,
                        0.08661787092222226,
                        0.08264608223584949,
                        0.08542733821020007,
                    ],
                    'estimated_false_negative': [
                        0.04957467963391336,
                        0.048578340120679596,
                        0.04524266097449394,
                        0.04813582797109456,
                        0.04867367504256423,
                        0.07599950541463074,
                        0.0740649726193573,
                        0.0739349563092676,
                        0.07343034614998886,
                        0.07535447373630481,
                    ],
                    'estimated_business_value': [
                        -20518.99288114649,
                        -19531.34562601404,
                        -19647.162691868405,
                        -19607.039050463114,
                        -20003.352580847743,
                        -19282.218574708404,
                        -19266.462434034747,
                        -19178.81937748659,
                        -19022.008517144695,
                        -19718.684004160303,
                    ],
                }
            ),
        ),
        (
            {
                'normalize_confusion_matrix': None,
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': [
                        '[0:4999]',
                        '[5000:9999]',
                        '[10000:14999]',
                        '[15000:19999]',
                        '[20000:24999]',
                        '[25000:29999]',
                        '[30000:34999]',
                        '[35000:39999]',
                        '[40000:44999]',
                        '[45000:49999]',
                    ],
                    'estimated_roc_auc': [
                        0.9707549113643061,
                        0.9710224276197865,
                        0.9714183710230127,
                        0.9711031289261209,
                        0.9711345926265325,
                        0.9611051833769545,
                        0.9618393909078314,
                        0.9610884839447085,
                        0.9625480927168266,
                        0.9613306854392768,
                    ],
                    'estimated_f1': [
                        0.948555321454138,
                        0.9465779465209089,
                        0.9488069354531159,
                        0.9476546805658866,
                        0.9488338110572719,
                        0.9232325655782327,
                        0.923595783273164,
                        0.9229020961475524,
                        0.9241722368115827,
                        0.9249152193013231,
                    ],
                    'estimated_precision': [
                        0.9425440716307568,
                        0.9431073537123396,
                        0.9442277523749669,
                        0.9446336452028188,
                        0.9453707449594683,
                        0.9148732952385749,
                        0.9143489884377147,
                        0.9133821290777778,
                        0.9173539177641505,
                        0.9145726617897999,
                    ],
                    'estimated_recall': [
                        0.9546437391537488,
                        0.95007417692678,
                        0.9534307499357034,
                        0.9506951010870748,
                        0.9523223421280594,
                        0.9317460031975845,
                        0.9330315141543621,
                        0.9326226021419973,
                        0.9310926704269641,
                        0.9354943725540698,
                    ],
                    'estimated_specificity': [
                        0.9372742491954283,
                        0.9446319110387503,
                        0.9458015988378999,
                        0.9459382667254527,
                        0.9442380077839293,
                        0.9054074470674046,
                        0.9054733303403276,
                        0.905142438988179,
                        0.9120143191041326,
                        0.9005790635739856,
                    ],
                    'estimated_accuracy': [
                        0.9462845122805443,
                        0.947306078326665,
                        0.949543087716159,
                        0.9482807229338969,
                        0.9483068458984663,
                        0.9191503008524827,
                        0.9197921095331023,
                        0.9193633916092473,
                        0.9217811573797979,
                        0.9191618588441066,
                    ],
                    'estimated_true_positive': [
                        2476.063276173998,
                        2334.1907004380405,
                        2337.9079148804176,
                        2340.802172812585,
                        2396.5148384722524,
                        2430.8183454488935,
                        2423.939168348382,
                        2413.155585023489,
                        2383.285478351263,
                        2489.4667853918354,
                    ],
                    'estimated_true_negative': [
                        2255.359285228724,
                        2402.339691195284,
                        2409.8075237003773,
                        2400.6014418568993,
                        2345.0193910200787,
                        2164.93315881352,
                        2175.0213793171297,
                        2183.6613730227473,
                        2225.6203085477264,
                        2106.3425088286976,
                    ],
                    'estimated_false_positive': [
                        150.93672382600215,
                        140.80929956195956,
                        138.09208511958207,
                        137.19782718741482,
                        138.48516152774786,
                        226.18165455110628,
                        227.06083165161834,
                        228.8444149765112,
                        214.71452164873693,
                        232.53321460816457,
                    ],
                    'estimated_false_negative': [
                        117.64071477127642,
                        122.66030880471597,
                        114.19247629962268,
                        121.39855814310047,
                        119.9806089799208,
                        178.06684118647985,
                        173.9786206828703,
                        174.338626977253,
                        176.37969145227322,
                        171.65749117130238,
                    ],
                    'estimated_business_value': [
                        -20518.99288114649,
                        -19531.34562601404,
                        -19647.162691868405,
                        -19607.039050463114,
                        -20003.352580847743,
                        -19282.218574708404,
                        -19266.462434034747,
                        -19178.81937748659,
                        -19022.008517144695,
                        -19718.684004160303,
                    ],
                }
            ),
        ),
        (
            {
                'normalize_confusion_matrix': 'all',
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': [
                        '[0:4999]',
                        '[5000:9999]',
                        '[10000:14999]',
                        '[15000:19999]',
                        '[20000:24999]',
                        '[25000:29999]',
                        '[30000:34999]',
                        '[35000:39999]',
                        '[40000:44999]',
                        '[45000:49999]',
                    ],
                    'estimated_roc_auc': [
                        0.9707549113643061,
                        0.9710224276197865,
                        0.9714183710230127,
                        0.9711031289261209,
                        0.9711345926265325,
                        0.9611051833769545,
                        0.9618393909078314,
                        0.9610884839447085,
                        0.9625480927168266,
                        0.9613306854392768,
                    ],
                    'estimated_f1': [
                        0.948555321454138,
                        0.9465779465209089,
                        0.9488069354531159,
                        0.9476546805658866,
                        0.9488338110572719,
                        0.9232325655782327,
                        0.923595783273164,
                        0.9229020961475524,
                        0.9241722368115827,
                        0.9249152193013231,
                    ],
                    'estimated_precision': [
                        0.9425440716307568,
                        0.9431073537123396,
                        0.9442277523749669,
                        0.9446336452028188,
                        0.9453707449594683,
                        0.9148732952385749,
                        0.9143489884377147,
                        0.9133821290777778,
                        0.9173539177641505,
                        0.9145726617897999,
                    ],
                    'estimated_recall': [
                        0.9546437391537488,
                        0.95007417692678,
                        0.9534307499357034,
                        0.9506951010870748,
                        0.9523223421280594,
                        0.9317460031975845,
                        0.9330315141543621,
                        0.9326226021419973,
                        0.9310926704269641,
                        0.9354943725540698,
                    ],
                    'estimated_specificity': [
                        0.9372742491954283,
                        0.9446319110387503,
                        0.9458015988378999,
                        0.9459382667254527,
                        0.9442380077839293,
                        0.9054074470674046,
                        0.9054733303403276,
                        0.905142438988179,
                        0.9120143191041326,
                        0.9005790635739856,
                    ],
                    'estimated_accuracy': [
                        0.9462845122805443,
                        0.947306078326665,
                        0.949543087716159,
                        0.9482807229338969,
                        0.9483068458984663,
                        0.9191503008524827,
                        0.9197921095331023,
                        0.9193633916092473,
                        0.9217811573797979,
                        0.9191618588441066,
                    ],
                    'estimated_true_positive': [
                        0.4952126552347996,
                        0.4668381400876081,
                        0.46758158297608354,
                        0.468160434562517,
                        0.47930296769445047,
                        0.4861636690897787,
                        0.48478783366967637,
                        0.4826311170046978,
                        0.4766570956702526,
                        0.49789335707836707,
                    ],
                    'estimated_true_negative': [
                        0.45107185704574476,
                        0.4804679382390568,
                        0.48196150474007543,
                        0.4801202883713799,
                        0.46900387820401573,
                        0.432986631762704,
                        0.43500427586342594,
                        0.43673227460454944,
                        0.44512406170954527,
                        0.42126850176573954,
                    ],
                    'estimated_false_positive': [
                        0.03018734476520043,
                        0.028161859912391913,
                        0.027618417023916413,
                        0.027439565437482962,
                        0.02769703230554957,
                        0.04523633091022126,
                        0.04541216633032367,
                        0.04576888299530224,
                        0.042942904329747386,
                        0.04650664292163292,
                    ],
                    'estimated_false_negative': [
                        0.023528142954255284,
                        0.024532061760943195,
                        0.022838495259924537,
                        0.024279711628620096,
                        0.02399612179598416,
                        0.03561336823729597,
                        0.03479572413657406,
                        0.0348677253954506,
                        0.035275938290454646,
                        0.034331498234260474,
                    ],
                    'estimated_business_value': [
                        -20518.99288114649,
                        -19531.34562601404,
                        -19647.162691868405,
                        -19607.039050463114,
                        -20003.352580847743,
                        -19282.218574708404,
                        -19266.462434034747,
                        -19178.81937748659,
                        -19022.008517144695,
                        -19718.684004160303,
                    ],
                }
            ),
        ),
        (
            {
                'normalize_confusion_matrix': 'true',
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': [
                        '[0:4999]',
                        '[5000:9999]',
                        '[10000:14999]',
                        '[15000:19999]',
                        '[20000:24999]',
                        '[25000:29999]',
                        '[30000:34999]',
                        '[35000:39999]',
                        '[40000:44999]',
                        '[45000:49999]',
                    ],
                    'estimated_roc_auc': [
                        0.9707549113643061,
                        0.9710224276197865,
                        0.9714183710230127,
                        0.9711031289261209,
                        0.9711345926265325,
                        0.9611051833769545,
                        0.9618393909078314,
                        0.9610884839447085,
                        0.9625480927168266,
                        0.9613306854392768,
                    ],
                    'estimated_f1': [
                        0.948555321454138,
                        0.9465779465209089,
                        0.9488069354531159,
                        0.9476546805658866,
                        0.9488338110572719,
                        0.9232325655782327,
                        0.923595783273164,
                        0.9229020961475524,
                        0.9241722368115827,
                        0.9249152193013231,
                    ],
                    'estimated_precision': [
                        0.9425440716307568,
                        0.9431073537123396,
                        0.9442277523749669,
                        0.9446336452028188,
                        0.9453707449594683,
                        0.9148732952385749,
                        0.9143489884377147,
                        0.9133821290777778,
                        0.9173539177641505,
                        0.9145726617897999,
                    ],
                    'estimated_recall': [
                        0.9546437391537488,
                        0.95007417692678,
                        0.9534307499357034,
                        0.9506951010870748,
                        0.9523223421280594,
                        0.9317460031975845,
                        0.9330315141543621,
                        0.9326226021419973,
                        0.9310926704269641,
                        0.9354943725540698,
                    ],
                    'estimated_specificity': [
                        0.9372742491954283,
                        0.9446319110387503,
                        0.9458015988378999,
                        0.9459382667254527,
                        0.9442380077839293,
                        0.9054074470674046,
                        0.9054733303403276,
                        0.905142438988179,
                        0.9120143191041326,
                        0.9005790635739856,
                    ],
                    'estimated_accuracy': [
                        0.9462845122805443,
                        0.947306078326665,
                        0.949543087716159,
                        0.9482807229338969,
                        0.9483068458984663,
                        0.9191503008524827,
                        0.9197921095331023,
                        0.9193633916092473,
                        0.9217811573797979,
                        0.9191618588441066,
                    ],
                    'estimated_true_positive': [
                        0.9546437391537488,
                        0.9500741769267799,
                        0.9534307499357034,
                        0.9506951010870749,
                        0.9523223421280593,
                        0.9317460031975845,
                        0.9330315141543621,
                        0.9326226021419972,
                        0.9310926704269642,
                        0.9354943725540699,
                    ],
                    'estimated_true_negative': [
                        0.9372742491954283,
                        0.9446319110387503,
                        0.9458015988378999,
                        0.9459382667254528,
                        0.9442380077839293,
                        0.9054074470674046,
                        0.9054733303403276,
                        0.9051424389881788,
                        0.9120143191041324,
                        0.9005790635739858,
                    ],
                    'estimated_false_positive': [
                        0.0627257508045717,
                        0.05536808896124974,
                        0.054198401162100104,
                        0.0540617332745473,
                        0.05576199221607062,
                        0.09459255293259536,
                        0.0945266696596724,
                        0.09485756101182109,
                        0.08798568089586746,
                        0.09942093642601435,
                    ],
                    'estimated_false_negative': [
                        0.04535626084625111,
                        0.04992582307322005,
                        0.04656925006429655,
                        0.04930489891292515,
                        0.0476776578719406,
                        0.06825399680241545,
                        0.06696848584563789,
                        0.06737739785800262,
                        0.06890732957303593,
                        0.06450562744593023,
                    ],
                    'estimated_business_value': [
                        -20518.99288114649,
                        -19531.34562601404,
                        -19647.162691868405,
                        -19607.039050463114,
                        -20003.352580847743,
                        -19282.218574708404,
                        -19266.462434034747,
                        -19178.81937748659,
                        -19022.008517144695,
                        -19718.684004160303,
                    ],
                }
            ),
        ),
        (
            {
                'normalize_confusion_matrix': 'pred',
                'timestamp_column_name': 'timestamp',
                'business_value_matrix': [[-1, 4], [8, -8]],
            },
            pd.DataFrame(
                {
                    'key': [
                        '[0:4999]',
                        '[5000:9999]',
                        '[10000:14999]',
                        '[15000:19999]',
                        '[20000:24999]',
                        '[25000:29999]',
                        '[30000:34999]',
                        '[35000:39999]',
                        '[40000:44999]',
                        '[45000:49999]',
                    ],
                    'estimated_roc_auc': [
                        0.9707549113643061,
                        0.9710224276197865,
                        0.9714183710230127,
                        0.9711031289261209,
                        0.9711345926265325,
                        0.9611051833769545,
                        0.9618393909078314,
                        0.9610884839447085,
                        0.9625480927168266,
                        0.9613306854392768,
                    ],
                    'estimated_f1': [
                        0.948555321454138,
                        0.9465779465209089,
                        0.9488069354531159,
                        0.9476546805658866,
                        0.9488338110572719,
                        0.9232325655782327,
                        0.923595783273164,
                        0.9229020961475524,
                        0.9241722368115827,
                        0.9249152193013231,
                    ],
                    'estimated_precision': [
                        0.9425440716307568,
                        0.9431073537123396,
                        0.9442277523749669,
                        0.9446336452028188,
                        0.9453707449594683,
                        0.9148732952385749,
                        0.9143489884377147,
                        0.9133821290777778,
                        0.9173539177641505,
                        0.9145726617897999,
                    ],
                    'estimated_recall': [
                        0.9546437391537488,
                        0.95007417692678,
                        0.9534307499357034,
                        0.9506951010870748,
                        0.9523223421280594,
                        0.9317460031975845,
                        0.9330315141543621,
                        0.9326226021419973,
                        0.9310926704269641,
                        0.9354943725540698,
                    ],
                    'estimated_specificity': [
                        0.9372742491954283,
                        0.9446319110387503,
                        0.9458015988378999,
                        0.9459382667254527,
                        0.9442380077839293,
                        0.9054074470674046,
                        0.9054733303403276,
                        0.905142438988179,
                        0.9120143191041326,
                        0.9005790635739856,
                    ],
                    'estimated_accuracy': [
                        0.9462845122805443,
                        0.947306078326665,
                        0.949543087716159,
                        0.9482807229338969,
                        0.9483068458984663,
                        0.9191503008524827,
                        0.9197921095331023,
                        0.9193633916092473,
                        0.9217811573797979,
                        0.9191618588441066,
                    ],
                    'estimated_true_positive': [
                        0.9425440716307567,
                        0.9431073537123397,
                        0.9442277523749669,
                        0.9446336452028189,
                        0.9453707449594684,
                        0.914873295238575,
                        0.9143489884377148,
                        0.9133821290777778,
                        0.9173539177641507,
                        0.9145726617897999,
                    ],
                    'estimated_true_negative': [
                        0.9504253203660866,
                        0.9514216598793204,
                        0.9547573390255062,
                        0.9518641720289054,
                        0.9513263249574359,
                        0.9240004945853693,
                        0.9259350273806426,
                        0.9260650436907325,
                        0.9265696538500111,
                        0.9246455262636951,
                    ],
                    'estimated_false_positive': [
                        0.05745592836924329,
                        0.056892646287660435,
                        0.055772247625033154,
                        0.055366354797181126,
                        0.054629255040531705,
                        0.08512670476142503,
                        0.0856510115622853,
                        0.08661787092222226,
                        0.08264608223584949,
                        0.08542733821020007,
                    ],
                    'estimated_false_negative': [
                        0.04957467963391336,
                        0.048578340120679596,
                        0.04524266097449394,
                        0.04813582797109456,
                        0.04867367504256423,
                        0.07599950541463074,
                        0.0740649726193573,
                        0.0739349563092676,
                        0.07343034614998886,
                        0.07535447373630481,
                    ],
                    'estimated_business_value': [
                        -20518.99288114649,
                        -19531.34562601404,
                        -19647.162691868405,
                        -19607.039050463114,
                        -20003.352580847743,
                        -19282.218574708404,
                        -19266.462434034747,
                        -19178.81937748659,
                        -19022.008517144695,
                        -19718.684004160303,
                    ],
                }
            ),
        ),
    ],
    ids=[
        'size_based_without_timestamp_cm_normalization_none_business_norm_none',
        'size_based_without_timestamp_cm_normalization_none_business_norm_per_pred',
        'size_based_without_timestamp_normalization_all_business_norm_none',
        'size_based_without_timestamp_normalization_true_business_norm_none',
        'size_based_without_timestamp_normalization_pred_business_norm_none',
        'sized_based_with_timestamp_cm_normalization_none_business_norm_none',
        'sized_based_with_timestamp_cm_normalization_all_business_norm_none',
        'sized_based_with_timestamp_cm_normalization_all_business_norm_per_pred',
        'sized_based_with_timestamp_normalization_true_business_norm_none',
        'sized_based_with_timestamp_normalization_pred_business_norm_none',
        'count_based_without_timestamp_normalization_none_business_norm_none',
        'count_based_without_timestamp_normalization_all_business_norm_none',
        'count_based_without_timestamp_normalization_true_business_norm_none',
        'count_based_without_timestamp_normalization_pred_business_norm_none',
        'count_based_with_timestamp_normalization_none_business_norm_none',
        'count_based_with_timestamp_normalization_all_business_norm_none',
        'count_based_with_timestamp_normalization_true_business_norm_none',
        'count_based_with_timestamp_normalization_pred_business_norm_none',
        'period_based_with_timestamp_normalization_none_business_norm_none',
        'period_based_with_timestamp_normalization_all_business_norm_none',
        'period_based_with_timestamp_normalization_true_business_norm_none',
        'period_based_with_timestamp_normalization_pred_business_norm_none',
        'default_without_timestamp_normalization_none_business_norm_none',
        'default_without_timestamp_normalization_all_business_norm_none',
        'default_without_timestamp_normalization_true_business_norm_none',
        'default_without_timestamp_normalization_pred_business_norm_none',
        'default_with_timestamp_normalization_none_business_norm_none',
        'default_with_timestamp_normalization_all_business_norm_none',
        'default_with_timestamp_normalization_true_business_norm_none',
        'default_with_timestamp_normalization_pred_business_norm_none',
    ],
)
def test_cbpe_for_binary_classification_with_timestamps(calculator_opts, expected):
    ref_df, ana_df, _ = load_synthetic_binary_classification_dataset()
    cbpe = CBPE(
        y_pred_proba='y_pred_proba',
        y_pred='y_pred',
        y_true='work_home_actual',
        problem_type='classification_binary',
        metrics=[
            'roc_auc',
            'f1',
            'precision',
            'recall',
            'specificity',
            'accuracy',
            'confusion_matrix',
            'business_value',
        ],
        **calculator_opts,
    ).fit(ref_df)
    result = cbpe.estimate(ana_df)

    metric_column_names = [name for metric in result.metrics for name in metric.column_names]
    sut = result.filter(period='analysis').to_df()[[('chunk', 'key')] + [(c, 'value') for c in metric_column_names]]
    sut.columns = [
        'key',
        'estimated_roc_auc',
        'estimated_f1',
        'estimated_precision',
        'estimated_recall',
        'estimated_specificity',
        'estimated_accuracy',
        'estimated_true_positive',
        'estimated_true_negative',
        'estimated_false_positive',
        'estimated_false_negative',
        'estimated_business_value',
    ]

    pd.testing.assert_frame_equal(expected, sut)


@pytest.mark.parametrize(
    'calculator_opts, expected',
    [
        (
            {'chunk_size': 20000},
            pd.DataFrame(
                {
                    'key': ['[0:19999]', '[20000:39999]', '[40000:59999]'],
                    'estimated_roc_auc': [0.9092530048158975, 0.8684079311351537, 0.8205039807439959],
                    'estimated_f1': [0.756401608336434, 0.6937135623882767, 0.632386421613214],
                    'estimated_precision': [0.7564437378390059, 0.694174192229447, 0.6336288859123612],
                    'estimated_recall': [0.7564129287764665, 0.6934788458355289, 0.6319310599943714],
                    'estimated_specificity': [0.8782068281303994, 0.8469556750949159, 0.8172644220189141],
                    'estimated_accuracy': [0.7564451493123628, 0.6946947603445697, 0.6378557309960986],
                }
            ),
        ),
        (
            {'chunk_size': 20000, 'timestamp_column_name': 'timestamp'},
            pd.DataFrame(
                {
                    'key': ['[0:19999]', '[20000:39999]', '[40000:59999]'],
                    'estimated_roc_auc': [0.9092530048158975, 0.8684079311351537, 0.8205039807439959],
                    'estimated_f1': [0.756401608336434, 0.6937135623882767, 0.632386421613214],
                    'estimated_precision': [0.7564437378390059, 0.694174192229447, 0.6336288859123612],
                    'estimated_recall': [0.7564129287764665, 0.6934788458355289, 0.6319310599943714],
                    'estimated_specificity': [0.8782068281303994, 0.8469556750949159, 0.8172644220189141],
                    'estimated_accuracy': [0.7564451493123628, 0.6946947603445697, 0.6378557309960986],
                }
            ),
        ),
        (
            {'chunk_number': 4},
            pd.DataFrame(
                {
                    'key': ['[0:14999]', '[15000:29999]', '[30000:44999]', '[45000:59999]'],
                    'estimated_roc_auc': [0.9085282712524355, 0.908855836626517, 0.8197227941098104, 0.820357813099581],
                    'estimated_f1': [0.7550059244451006, 0.7562711250144366, 0.63091155676697, 0.6324244687112559],
                    'estimated_precision': [
                        0.755038246904623,
                        0.7562647262876293,
                        0.6323547131368327,
                        0.6335323150520741,
                    ],
                    'estimated_recall': [
                        0.7550277340784216,
                        0.7562926950204228,
                        0.6304009454574501,
                        0.6320155112489632,
                    ],
                    'estimated_specificity': [
                        0.8775094795233379,
                        0.8781429133214084,
                        0.8165537125162895,
                        0.8172408983542975,
                    ],
                    'estimated_accuracy': [
                        0.7550428613792668,
                        0.7562888217426292,
                        0.6364205304514962,
                        0.6375753072973162,
                    ],
                }
            ),
        ),
        (
            {'chunk_number': 4, 'timestamp_column_name': 'timestamp'},
            pd.DataFrame(
                {
                    'key': ['[0:14999]', '[15000:29999]', '[30000:44999]', '[45000:59999]'],
                    'estimated_roc_auc': [0.9085282712524355, 0.908855836626517, 0.8197227941098104, 0.820357813099581],
                    'estimated_f1': [0.7550059244451006, 0.7562711250144366, 0.63091155676697, 0.6324244687112559],
                    'estimated_precision': [
                        0.755038246904623,
                        0.7562647262876293,
                        0.6323547131368327,
                        0.6335323150520741,
                    ],
                    'estimated_recall': [
                        0.7550277340784216,
                        0.7562926950204228,
                        0.6304009454574501,
                        0.6320155112489632,
                    ],
                    'estimated_specificity': [
                        0.8775094795233379,
                        0.8781429133214084,
                        0.8165537125162895,
                        0.8172408983542975,
                    ],
                    'estimated_accuracy': [
                        0.7550428613792668,
                        0.7562888217426292,
                        0.6364205304514962,
                        0.6375753072973162,
                    ],
                }
            ),
        ),
        (
            {'chunk_period': 'Y', 'timestamp_column_name': 'timestamp'},
            pd.DataFrame(
                {
                    'key': ['2020', '2021'],
                    'estimated_roc_auc': [0.8699046556903727, 0.8174976659905601],
                    'estimated_f1': [0.6959459683194374, 0.6271637037915178],
                    'estimated_precision': [0.696279612597813, 0.6275707355339551],
                    'estimated_recall': [0.6957620347508907, 0.6272720458900231],
                    'estimated_specificity': [0.8480220572478717, 0.8145095377877009],
                    'estimated_accuracy': [0.6967957612985849, 0.6305270354546132],
                }
            ),
        ),
        (
            {},
            pd.DataFrame(
                {
                    'key': [
                        '[0:5999]',
                        '[6000:11999]',
                        '[12000:17999]',
                        '[18000:23999]',
                        '[24000:29999]',
                        '[30000:35999]',
                        '[36000:41999]',
                        '[42000:47999]',
                        '[48000:53999]',
                        '[54000:59999]',
                    ],
                    'estimated_roc_auc': [
                        0.9070850078291697,
                        0.9099949916410729,
                        0.9100049015532864,
                        0.9091525470654199,
                        0.9072366448743271,
                        0.8196065429712586,
                        0.8203484506082215,
                        0.8192193154831209,
                        0.8194977218687874,
                        0.8216746926871311,
                    ],
                    'estimated_f1': [
                        0.7533014808638749,
                        0.7564216285126095,
                        0.7581655498090148,
                        0.7565574256686872,
                        0.7536178781761181,
                        0.6309845876312757,
                        0.6314817817562323,
                        0.6305520915509012,
                        0.6317356567785939,
                        0.6334434546737131,
                    ],
                    'estimated_precision': [
                        0.7533705392643878,
                        0.7564117249294325,
                        0.758189598004742,
                        0.7565615847700302,
                        0.7536066338250612,
                        0.6320478731185537,
                        0.632902872215884,
                        0.6320206664159113,
                        0.6327414423931249,
                        0.6349486020523588,
                    ],
                    'estimated_recall': [
                        0.7532927299604006,
                        0.756484874870973,
                        0.7581945446990431,
                        0.7565540393358208,
                        0.7536741378197004,
                        0.6306782567019867,
                        0.6308507454911164,
                        0.6299485723087591,
                        0.6315005643336115,
                        0.6328910840233342,
                    ],
                    'estimated_specificity': [
                        0.876648985916452,
                        0.8781935469456502,
                        0.87910164279675,
                        0.8783467614315459,
                        0.8767972368373717,
                        0.816629841587921,
                        0.8166384221108975,
                        0.8163342736347389,
                        0.8167795549189886,
                        0.8180293638991758,
                    ],
                    'estimated_accuracy': [
                        0.7533903547412437,
                        0.7564140260171383,
                        0.7582062911442542,
                        0.7566888307842633,
                        0.7536297051178407,
                        0.6358257165904244,
                        0.6366025073789935,
                        0.6367168031955528,
                        0.6365172577468735,
                        0.6393273094601863,
                    ],
                }
            ),
        ),
        (
            {'timestamp_column_name': 'timestamp'},
            pd.DataFrame(
                {
                    'key': [
                        '[0:5999]',
                        '[6000:11999]',
                        '[12000:17999]',
                        '[18000:23999]',
                        '[24000:29999]',
                        '[30000:35999]',
                        '[36000:41999]',
                        '[42000:47999]',
                        '[48000:53999]',
                        '[54000:59999]',
                    ],
                    'estimated_roc_auc': [
                        0.9070850078291697,
                        0.9099949916410729,
                        0.9100049015532864,
                        0.9091525470654199,
                        0.9072366448743271,
                        0.8196065429712586,
                        0.8203484506082215,
                        0.8192193154831209,
                        0.8194977218687874,
                        0.8216746926871311,
                    ],
                    'estimated_f1': [
                        0.7533014808638749,
                        0.7564216285126095,
                        0.7581655498090148,
                        0.7565574256686872,
                        0.7536178781761181,
                        0.6309845876312757,
                        0.6314817817562323,
                        0.6305520915509012,
                        0.6317356567785939,
                        0.6334434546737131,
                    ],
                    'estimated_precision': [
                        0.7533705392643878,
                        0.7564117249294325,
                        0.758189598004742,
                        0.7565615847700302,
                        0.7536066338250612,
                        0.6320478731185537,
                        0.632902872215884,
                        0.6320206664159113,
                        0.6327414423931249,
                        0.6349486020523588,
                    ],
                    'estimated_recall': [
                        0.7532927299604006,
                        0.756484874870973,
                        0.7581945446990431,
                        0.7565540393358208,
                        0.7536741378197004,
                        0.6306782567019867,
                        0.6308507454911164,
                        0.6299485723087591,
                        0.6315005643336115,
                        0.6328910840233342,
                    ],
                    'estimated_specificity': [
                        0.876648985916452,
                        0.8781935469456502,
                        0.87910164279675,
                        0.8783467614315459,
                        0.8767972368373717,
                        0.816629841587921,
                        0.8166384221108975,
                        0.8163342736347389,
                        0.8167795549189886,
                        0.8180293638991758,
                    ],
                    'estimated_accuracy': [
                        0.7533903547412437,
                        0.7564140260171383,
                        0.7582062911442542,
                        0.7566888307842633,
                        0.7536297051178407,
                        0.6358257165904244,
                        0.6366025073789935,
                        0.6367168031955528,
                        0.6365172577468735,
                        0.6393273094601863,
                    ],
                }
            ),
        ),
    ],
    ids=[
        'size_based_without_timestamp',
        'size_based_with_timestamp',
        'count_based_without_timestamp',
        'count_based_with_timestamp',
        'period_based_with_timestamp',
        'default_without_timestamp',
        'default_with_timestamp',
    ],
)
def test_cbpe_for_multiclass_classification_with_timestamps(calculator_opts, expected):
    ref_df, ana_df, _ = load_synthetic_multiclass_classification_dataset()
    cbpe = CBPE(
        y_pred_proba={
            'upmarket_card': 'y_pred_proba_upmarket_card',
            'highstreet_card': 'y_pred_proba_highstreet_card',
            'prepaid_card': 'y_pred_proba_prepaid_card',
        },
        y_pred='y_pred',
        y_true='y_true',
        problem_type='classification_multiclass',
        metrics=['roc_auc', 'f1', 'precision', 'recall', 'specificity', 'accuracy'],
        **calculator_opts,
    ).fit(ref_df)
    result = cbpe.estimate(ana_df)
    sut = result.filter(period='analysis').to_df()[[('chunk', 'key')] + [(m.name, 'value') for m in result.metrics]]
    sut.columns = [
        'key',
        'estimated_roc_auc',
        'estimated_f1',
        'estimated_precision',
        'estimated_recall',
        'estimated_specificity',
        'estimated_accuracy',
    ]

    pd.testing.assert_frame_equal(expected, sut)


@pytest.mark.parametrize(
    'metric_cls',
    [
        BinaryClassificationAUROC,
        BinaryClassificationF1,
        BinaryClassificationPrecision,
        BinaryClassificationRecall,
        BinaryClassificationSpecificity,
        BinaryClassificationAccuracy,
        BinaryClassificationConfusionMatrix,
    ],
)
def test_method_logs_warning_when_lower_threshold_is_overridden_by_metric_limits(caplog, metric_cls):
    reference, _, _ = load_synthetic_binary_classification_dataset()

    # TODO: move this from CBPE to metrics
    # workaround to deal with functionality outside of Metrics classes
    reference['uncalibrated_y_pred_proba'] = reference['y_pred_proba']

    metric = metric_cls(
        y_pred_proba='y_pred_proba',
        y_pred='y_pred',
        y_true='work_home_actual',
        problem_type='classification_binary',
        chunker=DefaultChunker(),
        threshold=ConstantThreshold(lower=-1),
    )
    metric.fit(reference)

    assert (
        f'{metric.display_name} lower threshold value -1 overridden by '
        f'lower threshold value limit {metric.lower_threshold_value_limit}' in caplog.messages
    )
